---
title: "The Geological Completeness of Paleontological Sampling in North America"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Geological Completeness of Paleontological Sampling in North America}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

**Authors:** [Palaeoverse Development Team](https://palaeoverse.org/#about-us)

**Last updated:** `r Sys.Date()`

```{r setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, eval = TRUE,
                      out.width = "100%", fig.width = 7.2, fig.height = 6, dpi = 200,
                      fig.path = "")
library(devtools)
load_all()
```

<div style="text-align: justify">

# Introduction

`rmacrostrat` is an R package that allows users to easily retrieve geological data from the [Macrostrat](https://macrostrat.org) database and facilitate analyses within the R environment. This vignette (or tutorial if you prefer) is provided to guide you through the installation process and some of the functionality available within `rmacrostrat`. To do so, we will focus on reconstructing a classical figure (i.e., Fig. 14) from Peters & Heim (2010), which visualizes the changing number, and proportion, of different lithostratigraphic units throughout the Phanerozoic, the last 540 million years. Let's get started!

# Installation

The `rmacrostrat` package can be installed via CRAN or its dedicated [GitHub repository](https://github.com/palaeoverse/rmacrostrat) if the development version is preferred. To install via the CRAN, simply use:

```{r install, eval = FALSE}
install.packages("rmacrostrat")
```

To install the development version, first install the `devtools` package, and then use `install_github` to install `rmacrostrat`` directly from GitHub.

```{r install-dev, eval = FALSE}
install.packages("devtools")
devtools::install_github("palaeoverse/rmacrostrat")
```

You can now load `rmacrostrat` using the default `library` function:

```{r load-library, eval = TRUE}
library(rmacrostrat)
```

**Before we get onto the good stuff, the development team has a small request**. If you use `rmacrostrat` in your research, please cite the associated publication. This will help us to continue our work in supporting you to do yours. You can access the appropriate citation via:

```{r citation, eval = TRUE}
citation("rmacrostrat")
```

# Context

Quantifying the number and type of lithostratigraphic units through time and space is fundamental to understanding how environments and biodiversity have evolved and responded to Earth history events throughout the Phanerozoic. For instance, how does the proportion of different paleoenvironment lithostratigraphic unit types (e.g., marine, marginal, terrestrial) vary through time, and how might it influence the preservation of different organisms? To begin investigating this question, we will examine how the number and proportion of different lithostratigraphic units, grouped by paleoenvironment type, change throughout the Phanerozoic. To do so, we will make use of the `rmacrostrat` package to fetch data from the [Macrostrat](https://macrostrat.org) database.

# Fetch

To quantify how the number and proportion of different lithostraphic units change through time we will focus on the following paleoenvironmental groupings: marine, marginal, and terrestrial. The first step to establish these groupings is to see what different environments are available:

*Hint: Remember that all definitions of data stored in [Macrostrat](https://macrostrat.org) are available via the `def_` suite of functions.*

```{r environments, eval = TRUE}
# What environments are available?
# Hint: Defining no arguments returns all environments
environments <- def_environments()
head(environments)
```

From this call, we can see a whole suite of inferred paleoenvironments are available, which are conveniently group into type (e.g., carbonate, fluvial, lacustrine) and class (i.e., marine and non-marine). Class seems helpful for defining between marine and non-marine environments, but we also want a marginal class, so we need to re-classify some of these environment definitions! 

After some deliberation, we go with defining which paleoenvironments are marginal using the additional information available in the `name` column of `environments`. For this definition, let's consider that any environment that is classified as a delta, beach, barrier island, estuary, lagoon, and tidal flat as a marginal environment. From our available environments (*n* = 87), we pick 22 as marginal environments. This can be a little subjective, but this vector provides a good enough representation of marginal environments for this example here:

```{r marginal, eval = TRUE}
# Define an object classifying marginal palaeoenvironments
marginal <- c("shallow subtidal", "open shallow subtidal", 
              "lagoonal/restricted shallow subtidal", "paralic indet.", 
              "lagoonal", "coastal indet.", "foreshore", "shoreface",
              "transition zone/lower shoreface", "barrier bar",
              "deltaic indet.", "delta plain", "interdistributary bay",
              "delta front", "prodelta", "marginal marine",
              "deltaic indet.", "delta plain", "lacustrine deltaic indet.",
              "lacustrine delta plain", "lacustrine prodelta", "playa")
```

Now we've classified our marginal paleoenvironments, we can re-classify the `class` column in `environments` so that we have three categories. We can also replace non-marine environments with terrestrial:

```{r recode, eval = TRUE}
# Update class to be marginal
environments$class[which(environments$name %in% marginal)] <- "marginal"
# Let's also change the name of non-marine class to terrestrial
environments$class[which(environments$class == "non-marine")] <- "terrestrial"
```

Hmmmm our lines of code are getting a little long and hard to read, let's make this simpler and create three `data.frame`s, one for each paleonvironment.

```{r classes, eval = TRUE}
# Subset dataframe
marine <- subset(environments, class == "marine")
marginal <- subset(environments, class == "marginal")
terrestrial <- subset(environments, class == "terrestrial")
```

Now we have three dataframes, one for each class of paleoenvironments. Using the `t_units` column in these dataframes, we can make use of the `t_units` column to make a quick estimate of the total number of units belonging to each of these categories:

```{r t_units, eval = TRUE}
# How many units are marine?
sum(marine$t_units)
# How many units are marginal?
sum(marginal$t_units)
# How many units are terrestrial?
sum(terrestrial$t_units)
```

From this quick summary, we can see that most lithostratigraphic units throughout the Phanerozoic are marine palaeoenvironments, followed by terrestrial, and then marginal. However, if we want to investigate how this changes through time, we need a little more information. Specifically, we need to know the inferred palaeoenvironment and age of specific lithostratigraphic units. We can retrieve such information about lithostratigraphic units using the `get_units` function. Conveniently, we can request such data for each paleoenvironment class using the `environ_id` column. 

*Hint: Remember that to retrieve data stored in [Macrostrat](https://macrostrat.org) (e.g. Macrostrat columns, sections, and units), the `get_` suite of functions must be used.*

```{r get_units, eval = TRUE}
# Retrieve marine units
marine <- get_units(environ_id = marine$environ_id)
# Retrieve marginal units
marginal <- get_units(environ_id = marginal$environ_id)
# Retrieve terrestrial units
terrestrial <- get_units(environ_id = terrestrial$environ_id)
# Let's also update the environment class in these dataframes for consistency
marine$environ_class <- "Marine"
marginal$environ_class <- "Marginal"
terrestrial$environ_class <- "Terrestrial"
```

Nice! That was pretty straight forward. However, something weird has happened. If we go back, we see that we had a total of X units (marine = X, marginal = X, terrestrial = X), but we notice the sum of the number of rows across our units dataframes is higher (each row in the dataframe represents one unit).

```{r sum_rows, eval = TRUE}
# Sum rows
sum(nrow(marine), nrow(marginal), nrow(terrestrial))
```

On investigation, we notice that some lithostratigraphic units are composed of multiple paleoenvironments (various combinations of marine, marginal, and terrestrial). Interesting! Let's treat these differently and make a new unit class called "mixed", and remove these units from the other dataframes.

```{r create_mixed, eval = TRUE}
# Marine 
# What unit IDs are shared between marine, terrestrial and marginal?
shared_id <- c(
  # Marine
  marine$unit_id[which(marine$unit_id %in% terrestrial$unit_id)],
  marine$unit_id[which(marine$unit_id %in% marginal$unit_id)],
  # Marginal
  marginal$unit_id[which(marginal$unit_id %in% marine$unit_id)],
  marginal$unit_id[which(marginal$unit_id %in% terrestrial$unit_id)],
  # Marginal
  terrestrial$unit_id[which(marginal$unit_id %in% marine$unit_id)],
  terrestrial$unit_id[which(marginal$unit_id %in% terrestrial$unit_id)]
)
# Get unique IDs
shared_id <- unique(shared_id)
# Combine all dataframes
litho_units <- rbind.data.frame(marine, marginal, terrestrial)
# Recode environment class
litho_units$environ_class[which(litho_units$unit_id %in% shared_id)] <- "Mixed"
# Retain unique units
litho_units <- unique(litho_units)
```

Great, we can now see that we have the correct number of lithostratigraphic units and we don't have a duplicate units in our dataset anymore. Now we've got our data and done a bit of wrangling, let's get on with summarising our data.

# Summarize

We are interested in how the number and proportion of lithostratigraphic units representing different paleoenvironments changes through time. Conveniently, lithostratigraphic units in [Macrostrat](https://macrostrat.org) have age information associated with them, specifically the minimum (`t_age`) and maximum (`b_age`) age in millions of years before present. Using this data, with some handy functions from the `palaeoverse` R package, we can count the number of lithographic units within each group within each time bin. We will use international stratigraphic stages as our time bins for this:

```{r counts, eval = TRUE}
# Load palaeoverse R package
library(palaeoverse)
# Generate time bins
bins <- time_bins(rank = "stage")
# Rename age columns to be consistent
colnames(litho_units)[which(colnames(litho_units) == "b_age")] <- "max_ma"
colnames(litho_units)[which(colnames(litho_units) == "t_age")] <- "min_ma"
# As we are only interested in the Phanerozoic, let's remove 
# data that has a minimum age of more than 541 Ma 
litho_units <- subset(litho_units, min_ma <= 541)
# In case the maximum age of units exceeds 541, but the minimum 
# age is less than 541, let's set it to 541 to still count it in 
# the Fortunian
litho_units$max_ma[which(litho_units$max_ma > 541)] <- 541
# Bin data using the bin_time function from palaeoverse with
# the "all" method. This will bin units into all bins the
# unit overlaps with
litho_units <- bin_time(occdf = litho_units,
                        bins = bins,
                        min_ma = "min_ma", 
                        max_ma = "max_ma",
                        method = "all")
# Let's calculate the number of environment classes per bin midpoint age
# Remember, each row is a unit within a time bin
counts <- group_apply(occdf = litho_units, 
            group = c("environ_class", "bin_assignment"),
            fun = nrow)
# Rename columns to ease reading and merging
colnames(counts) <- c("count", "environment", "bin")
# Merge datasets
counts <- merge(x = bins, y = counts, by = "bin")
```

# Visualize

Now we have our summary of the lithostratigraphic units, we can visualise this data. Let's make two plots, one of the number of units within each paleoenvironment group through time, and another of the proportion of units within each paleoenvironment group through time. To support this data visualization, we will use the `ggplot2` (plotting) and `deeptime` (adding a geological timescale axis) R packages.

```{r visualize, eval = TRUE}
# Load data visualization packages
library(ggplot2)
library(deeptime)
 
# Generate a plot of raw counts of lithostratigraphic units through time
# grouped by paleoenvironment
ggplot(counts, aes(fill = environment, y = count, x = mid_ma)) + 
  # Stacked bar chart with bar width of determined by interval duration
  geom_bar(position = "stack", stat = "identity", width = counts$duration_myr,
           color = "black", linewidth = 0.1) +
  # Label y-axis
  scale_y_continuous("Number of lithostratigraphic units") +
  # Label x-axis and reverse direction
  scale_x_reverse("Time (Ma)") +
  # Data plotting colors
  scale_fill_viridis_d() +
  # Theming 
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "top") +
  # Add geological timescale
  coord_geo()

# Generate a plot of lithostratigraphic units through time grouped by
# paleoenvironment as proportions
ggplot(counts, aes(fill = environment, y = count, x = mid_ma)) + 
  # Proportional bar chart with bar width of determined by interval duration
  geom_bar(position = "fill", stat = "identity", width = counts$duration_myr,
           color = "black", linewidth = 0.1) +
  # Label y-axis
  scale_y_continuous("Proportion of lithostratigraphic units") +
  # Label x-axis and reverse direction
  scale_x_reverse("Time (Ma)") +
  # Data plotting colors
  scale_fill_viridis_d() +
  # Theming
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "top") +
  # Add geological timescale
  coord_geo()
```

# References

Peters, S.E. and Heim, N.A. 2010. The Geological Completeness of Paleontological Sampling in North America. *Paleobiology* 36(10), pp61--79.

</style>
